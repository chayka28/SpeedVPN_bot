import asyncio
import logging
from datetime import datetime, timedelta
from aiogram import Bot
from config import TOKEN
import database as db

logger = logging.getLogger(__name__)

bot = Bot(token=TOKEN)

async def daily_subscription_check():
    """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–æ–∫ –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."""
    while True:
        now = datetime.utcnow()
        tomorrow = now + timedelta(days=1)

        with db.Session() as session:
            users = session.query(db.User).filter(
                db.User.subscription_end != None,
                db.User.subscription_end.between(now, tomorrow)
            ).all()

            for user in users:
                try:
                    logger.info(f"üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.telegram_id} –æ —Å–∫–æ—Ä–æ–º –æ–∫–æ–Ω—á–∞–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–∫–∏")
                    await bot.send_message(
                        chat_id=user.telegram_id,
                        text=(
                            "‚è≥ *–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ!* –í–∞—à–∞ –ø–æ–¥–ø–∏—Å–∫–∞ SpeedVPN –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –∑–∞–≤—Ç—Ä–∞.\n\n"
                            "–ü—Ä–æ–¥–ª–∏—Ç–µ –µ—ë, —á—Ç–æ–±—ã –Ω–µ –ø–æ—Ç–µ—Ä—è—Ç—å –¥–æ—Å—Ç—É–ø –∫ VPN üîê\n"
                            "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ üëá"
                        ),
                        parse_mode="Markdown"
                    )
                except Exception as e:
                    logger.error(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ {user.telegram_id}: {e}")

        # –∂–¥—ë–º –¥–æ —Å–ª–µ–¥—É—é—â–µ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
        await asyncio.sleep(24 * 60 * 60)

async def start_notifier():
    """–ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫"""
    logger.info("üïí –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–æ–∫ –∑–∞–ø—É—â–µ–Ω–∞ (–µ–∂–µ–¥–Ω–µ–≤–Ω–æ)")
    asyncio.create_task(daily_subscription_check())
